# 🎮 CodexPad Extension for micro:bit MakeCode

[English](READMD.md)

## 概述

CodexPad扩展是一个专为micro:bit MakeCode设计的CodexPad手柄控制库，允许micro:bit通过蓝牙连接CodexPad手柄，并读取其所有按键和摇杆的输入状态。CodexPad 是一款自主研发的主从一体蓝牙低功耗（BLE）手柄，专为物联网设备和嵌入式系统设计。这个扩展提供了完整的手柄控制功能，非常适合用于游戏开发、遥控机器人、交互式项目等各种应用场景。

## 主要特性

### 1. 连接管理

- **蓝牙连接**：支持通过蓝牙MAC地址连接CodexPad手柄
- **连接状态检测**：实时监测手柄的连接与断开状态
- **连接事件**：提供连接和断开时的回调函数

### 2. 按键控制

- **完整的按键映射**：支持方向键、功能键、肩键、菜单键等按键
- **多种按键状态**：
  - 按下检测（pressed）
  - 释放检测（released）
  - 按住检测（holding）
  - 实时状态（state）
- **按键事件**: 为每个按键状态提供独立的事件回调

### 3. 摇杆控制

- **双摇杆支持**：支持左右摇杆的X轴和Y轴输入
- **精确数值**：提供0-255范围的精确数值（中心值约为128±5）
- **变化检测**：可设置阈值检测摇杆值的变化
- **变化事件**：摇杆值变化超过阈值时触发回调

### 4. 输入处理

- **自动更新**：通过update函数统一更新所有输入状态
- **状态跟踪**：自动记录前一帧和当前帧的输入状态
- **防抖动**：内置的阈值机制防止摇杆微小变化带来的误触发

## 使用说明

### 1. 添加扩展库

在MakeCode中添加CodexPad扩展：

1. 打开 [MakeCode for micro:bit](https://makecode.microbit.org/)

2. 创建一个新项目或打开现有项目

3. 点击扩展（在齿轮菜单中）

4. 在搜索框中输入：`https://github.com/CodexPad/codex_pad_makecode_extension`

5. 选择CodexPad扩展并添加到项目

### 2. ⚠️ 重要提示：模块冲突解决

> ⚠️ 首次添加CodexPad扩展时，系统会提示此扩展与无线（Radio）模块冲突：

- 无论通过示例链接打开项目，还是手动添加该扩展
- 必须在弹出的对话框中选择"确认删除"无线（Radio）模块
- 这是确保蓝牙功能正常工作的必要步骤

### 3. 连接前准备工作

#### 3.1 学习手柄使用

- 请先仔细阅读CodexPad产品手册
- 熟悉手柄的基本操作和功能特性
- 了解各个按键和摇杆的布局

#### 3.2 获取手柄MAC地址

>⚠️ 重要：连接需要在代码中指定手柄的MAC地址

参考产品手册说明获取您手柄的MAC地址，记录下格式如："E4:66:E5:A2:24:5D"的地址，后续在代码中或者图形化块中替换。

#### 3.3 代码中配置MAC地址

在`启动接收服务`的图形化块中或者函数`codex_pad.startReceiverService("E4:66:E5:A2:24:5D")`将默认MAC地址替换为您手柄的实际地址

## 示例

> ⚠️ 在开始以下示例前，请确保您已完成[“使用说明”](#使用说明)中的所有准备工作。

**使用须知**：

  1. **MAC地址替换**：示例运行前，请先修改示例中的MAC地址为您手柄的MAC地址
  1. **自动连接**：示例运行后，手柄会自动扫描并尝试连接，无需人为干预。您只需确保CodexPad手柄处于开机状态，连接成功后，手柄上的蓝牙连接指示灯会常亮。
  1. **查看串口输出**：运行示例后，请立即转到MakeCode的 “**Show Data 设备**” （“**Show data Device**”）界面观察**串口信息输出**。

### 示例1：基础轮询示例

- **示例链接**：<https://makecode.microbit.org/S92002-05924-33203-41301>
- **示例说明**：该示例代码实现了Micro:bit与**CodexPad**游戏手柄通过蓝牙连接的基础轮询功能。
- **运行结果**：
  - Micro:bit首先显示笑脸图标（`IconNames.Happy`），并启动蓝牙接收服务等待连接。
  - 连接成功后，Micro:bit**串口输出"connected"**，同时**LED点阵屏显示对勾图标**（`IconNames.Yes`），手柄的蓝牙连接指示灯常亮。
  - 断开连接时，**串口输出"disconnected"**，同时**LED点阵屏显示叉图标**（`IconNames.No`）。
  - 连接成功后：
    - 按下手柄按键时， Micro:bit的LED屏会显示如下字符：

        | 按键 | 显示字符 |
        | --- | --- |
        | Up | ↑ |
        | Down | ↓ |
        | Left | ← |
        | Right | ↓ |
        | Square(X) | X |
        | Triangle(Y) | Y |
        | Circle(B) | B |
        | Cross(A) | A |
        | L1 | 1 |
        | L2 | 2 |
        | L3 | 3 |
        | R1 | 4 |
        | R2 | 5 |
        | R3 | 6 |
        | Select | 7 |
        | Start | 8 |
        | Home | 9 |

    - 操作手柄按键时， Micro:bit会通过串口输出所有按键操作（pressed、 released、 holding）的信息

    - 操作左右摇杆时，Micro:bit的LED屏会显示摇杆的偏移对应方向的字符

        | 摇杆方向 | 显示字符 |
        | --- | --- |
        | 左 | ← |
        | 左上 | ↖ |
        | 左下 | ↙ |
        | 上 | ↑ |
        | 右上 | ↗ |
        | 右 | → |
        | 右下 | ↘ |
        | 下 | ↓ |

    - 操作左右摇杆时， Micro:bit会通过串口输出摇杆XY轴的坐标值（0 ~ 255）

- **核心特性**：
  - **轮询检测机制**：在主循环中持续调用 `codex_pad.update()` 并检测手柄状态变化。
  - **完整按钮支持**：支持所有按钮的按下（pressed）、释放（released）、保持（holding）状态检测。
  - **摇杆实时监控**：检测左右摇杆坐标变化，变化阈值设为2。
- **适用场景**：适用于需要实时监控所有手柄输入的项目。
- **重要提示**：在MakeCode环境中添加**CodexPad**扩展时，系统可能提示与无线（Radio）模块冲突，请务必选择**确认删除无线（Radio）块**。

### 示例2：事件驱动示例

- **示例链接**：<https://makecode.microbit.org/S87495-48874-28272-18977>
- **示例说明**：该示例代码实现了Micro:bit与**CodexPad**游戏手柄通过蓝牙连接的事件监听功能。
- **运行结果**：
  - Micro:bit首先显示桃心图标（`IconNames.Heart`），并启动蓝牙接收服务等待连接。
  - 连接成功后，Micro:bit**串口输出"connected"**，同时**LED点阵屏显示对勾图标**（`IconNames.Yes`），手柄的蓝牙连接指示灯常亮。
  - 断开连接时，**串口输出"disconnected"**，同时**LED点阵屏显示叉图标**（`IconNames.No`）。
  - 连接成功后：
    - 按下手柄按键时， Micro:bit的LED屏会显示如下字符：

        | 按键 | 显示字符 |
        | --- | --- |
        | Up | ↑ |
        | Down | ↓ |
        | Left | ← |
        | Right | ↓ |
        | Square(X) | X |
        | Triangle(Y) | Y |
        | Circle(B) | B |
        | Cross(A) | A |
        | L1 | 1 |
        | L2 | 2 |
        | L3 | 3 |
        | R1 | 4 |
        | R2 | 5 |
        | R3 | 6 |
        | Select | 7 |
        | Start | 8 |
        | Home | 9 |

    - 操作手柄按键时， Micro:bit会通过串口输出所有按键操作（pressed、 released、 holding）的信息

    - 操作左右摇杆时，Micro:bit的LED屏会显示摇杆的偏移对应方向的字符

        | 摇杆方向 | 显示字符 |
        | --- | --- |
        | 左 | ← |
        | 左上 | ↖ |
        | 左下 | ↙ |
        | 上 | ↑ |
        | 右上 | ↗ |
        | 右 | → |
        | 右下 | ↘ |
        | 下 | ↓ |

    - 操作左右摇杆时， Micro:bit会通过串口输出摇杆XY轴的坐标值（0 ~ 255）

- **核心特性**：
  - **事件驱动架构**：通过注册回调函数（如 onButtonPressed, onAxisValueChanged）来响应特定事件。请注意，为了驱动事件处理机制，您仍然需要在主循环中持续调用 codex_pad.update()函数。​ 此调用负责检查底层数据并触发相应的回调函数，其本身是非阻塞的。
  - **精细化事件监听**：可以为不同按钮的不同状态（按下、释放、保持）分别注册独立的处理函数。
  - **主从分工**：basic.forever主循环负责驱动（通过调用 update），而注册的事件处理函数负责响应。这避免了在主循环中编写复杂的条件判断语句，使代码结构更清晰。
- **适用场景**：适用于需要快速、独立响应特定操作的交互应用，代码结构更清晰。

## 应用场景

- **游戏控制**：开发基于micro:bit的游戏，使用手柄进行控制
- **机器人遥控**：控制机器人移动、抓取等动作
- **交互装置**：构建交互式艺术装置或展览
- **教育项目**：教学中的物理实验、互动演示等
- **原型开发**：快速开发需要物理输入的原型系统

## Supported targets

- for PXT/microbit

## License

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件。

---
*CodexPad - 让嵌入式开发更简单*
